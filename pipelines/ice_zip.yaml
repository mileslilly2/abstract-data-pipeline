version: 1
steps:
  # ─────────────────────────────
  # 1. Download raw ICE spreadsheets (ZIP)
  # ─────────────────────────────
  - id: ice_zip
    uses: ep:ice.download_zip
    params:
      url: "https://ucla.box.com/shared/static/f9ish3m738cnke6xo1f4h7xnsc1b17x0.zip"
      outdir: "data/ice/raw"   # extract ZIP here

  # ─────────────────────────────
  # 2. Convert Excel files → CSV
  # ─────────────────────────────
  - id: convert_csv
    uses: ep:ice.xlsx_to_csv
    needs: [ice_zip]
    params:
      folder: "data/ice/raw/ice_release_jul2025"   # actual folder with .xlsx files
      outdir: "data/ice/csv"

  # ─────────────────────────────
  # 3. List CSV files (instead of Excel)
  # ─────────────────────────────
  - id: csv_files
    uses: ep:ice.local_files
    needs: [convert_csv]
    params:
      folder: "data/ice/csv"

  # ─────────────────────────────
  # 4. Clean CSV → normalized rows
  # ─────────────────────────────
  - id: cleaned_rows
    uses: ep:ice.detect_headers
    needs: [csv_files]

  # ─────────────────────────────
  # 5. Summarize the rows
  # ─────────────────────────────
  - id: summarize
    needs: [cleaned_rows]
    uses: ep:ice.summary_json
    params:
      outfile: "data/ice/summary.json"
      group_by: ["gender", "citizenship", "arresting_agency"]
      numeric_fields: ["age"]
      top_n: 30

  # ─────────────────────────────
  # 6. Write out both CSV + JSON per file
  # ─────────────────────────────
  - id: cleaned_sink
    uses: ep:ice.csv_sink
    needs: [cleaned_rows]
    params:
      outdir: "data/ice/clean"

  # ─────────────────────────────
  # 7. Download TIGER shapefile
  # ─────────────────────────────
  - id: states
    uses: ep:ice.states_shapefile
    params:
      year: 2024
      outdir: "data/shapes"

  # ─────────────────────────────
  # 8. Time-series arrests → JSON
  # ─────────────────────────────
  - id: ts_arrests
    uses: ep:ice.ts_arrests
    needs: [cleaned_rows]

  # ─────────────────────────────
  # 9. Choropleth (detentions per state) → GeoJSON
  # ─────────────────────────────
  - id: choropleth
    uses: ep:ice.choropleth
    needs: [cleaned_rows, states]
    params:
      shapefile: "data/shapes/tl_2024_us_state.shp"

  # ─────────────────────────────
  # 10. Pipeline events sample → JSON
  # ─────────────────────────────
  - id: events_merged
    uses: ep:ice.pipeline_events_merged
    needs: [cleaned_sink]
    params:
      cleaned_dir: "data/ice/clean"
      outfile: "out/pipeline_events_sample.json"
      sample_n: 100000

  # ─────────────────────────────
  # 11. Feature importance (ML) → JSON
  # ─────────────────────────────
  - id: feat_imp
    uses: ep:ice.feature_importance
    needs: [cleaned_rows]
    params:
      enable_ml: false   # toggle here
